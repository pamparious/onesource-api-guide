<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TR ONESOURCE E-Invoicing Integration Guide - AR/AP flows, PUF format, status polling, and error handling">
    <title>E-Invoicing Integration | TR ONESOURCE</title>

    <!-- Dark Mode Detection (must run before styles to avoid flash) -->
    <script>
        (function() {
            const cl = document.documentElement.classList;
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                cl.add('dark');
            }
        })();
    </script>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/chatbot.css">

    <!-- Prism.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Fixed Header -->
    <header class="site-header">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; height: 100%; padding: 0 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="index.html" class="navbar-brand" style="display: flex; align-items: center; gap: 1rem; text-decoration: none;">
                    <div style="background-color: white; padding: 4px 8px; border-radius: 4px; display: flex; align-items: center;">
                        <img src="assets/images/Thomson-Reuters-Logo-500x281.png" alt="Thomson Reuters" style="height: 24px; width: auto;">
                    </div>
                    <div style="border-left: 2px solid #444; height: 32px; margin: 0 0.25rem;"></div>
                    <span style="font-size: 0.875rem; color: #cccccc; font-weight: 500; white-space: nowrap;">ONESOURCE API Guide</span>
                </a>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button id="headerAIButton" class="header-ai-button" aria-label="Open AI Assistant">
                    <i class="fas fa-robot"></i>
                    <span class="ai-button-text">AI Assistant</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Overlay for mobile sidebar -->
    <div class="sidebar-overlay"></div>

    <!-- Main Container -->
    <div id="retype-container">
        <!-- Left Sidebar Navigation -->
        <aside class="sidebar-left">
            <nav class="sidebar-nav">
                <!-- Home Section -->
                <div class="nav-section">
                    <a href="index.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-home" style="margin-right: 0.5rem; width: 20px;"></i> Home</span>
                    </a>
                </div>

                <!-- Getting Started Section -->
                <div class="nav-section">
                    <a href="getting-started.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-rocket" style="margin-right: 0.5rem; width: 20px;"></i> Getting Started</span>
                    </a>
                </div>

                <!-- E-Invoicing Integration Section (Active) -->
                <div class="nav-section">
                    <div class="nav-section-title active">
                        <span><i class="fas fa-file-invoice" style="margin-right: 0.5rem; width: 20px;"></i> E-Invoicing Integration</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-section-items">
                        <a href="#ar-flow" class="nav-item">AR Outbound Flow</a>
                        <a href="#ap-flow" class="nav-item">AP Inbound Flow</a>
                        <a href="#puf-format" class="nav-item">PUF Format</a>
                        <a href="#status-polling" class="nav-item">Status Polling</a>
                        <a href="#error-handling" class="nav-item">Error Handling</a>
                        <a href="#code-examples" class="nav-item">Code Examples</a>
                    </div>
                </div>

                <!-- API Reference Section -->
                <div class="nav-section">
                    <a href="api-reference.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-code" style="margin-right: 0.5rem; width: 20px;"></i> API Reference</span>
                    </a>
                </div>

                <!-- FAQ Section -->
                <div class="nav-section">
                    <a href="faq.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-question-circle" style="margin-right: 0.5rem; width: 20px;"></i> FAQ</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <main class="main-content-area">
                <h1 id="overview">E-Invoicing Integration Guide</h1>
                <p class="intro" style="font-size: 1.125rem; color: var(--color-gray); margin-bottom: 2rem;">
                    Accounts Receivable, Accounts Payable, PUF Format, Status Polling, and Error Handling
                </p>

                <h2 id="ar-flow">Accounts Receivable (AR) - Outbound Invoice Flow</h2>
                <p class="intro">
                    This section covers sending invoices FROM your clients TO their customers. The AR flow handles
                    invoice submission, validation, clearance, and delivery tracking.
                </p>

                <h3>AR Flow Overview</h3>
                <div class="diagram">┌──────────────────────────────────────────────────────────────────┐
│ YOUR PLATFORM                                                    │
│                                                                  │
│ 1. Invoice Created → 2. Generate PUF → 3. POST /documents       │
│                                                                  │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────┐
│ ONESOURCE PLATFORM                                               │
│                                                                  │
│ 4. Validate → 5. Convert → 6. Clear (if CTC) → 7. Deliver       │
│                                                                  │
└───────────────────────────┬──────────────────────────────────────┘
                            │
                            ▼
           ┌────────────────┴────────────────┐
           │                                 │
           ▼                                 ▼
  ┌─────────────────┐              ┌─────────────────┐
  │ Tax Authority   │              │ Customer        │
  │ (if CTC)        │              │ (Recipient)     │
  └─────────────────┘              └─────────────────┘</div>

                <h3>Step 1: POST Document</h3>
                <p><strong>Endpoint:</strong></p>
                <pre><code class="language-http">POST /einvoicing/document/v1/documents
Authorization: Bearer {access_token}
Content-Type: application/json</code></pre>

                <p><strong>Request Body:</strong></p>
                <pre><code class="language-json">{
  "payload": "&lt;Invoice xmlns:cac=\"urn:pagero:CommonAggregateComponents:1.0\"...&gt;",
  "documentType": "Invoice",
  "senderReference": "INV-2025-001234-UNIQUE",
  "sendingCompanyId": "89d671a5-a02f-4cd0-b1db-5c516f1791aa",
  "systemType": "Other",
  "systemName": "YourPlatformName",
  "documentIdentifier": "INV-2025-001234"
}</code></pre>

                <h4>Field Descriptions</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Required</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>payload</code></td>
                            <td>Yes</td>
                            <td>PUF XML as string (entire XML document)</td>
                        </tr>
                        <tr>
                            <td><code>documentType</code></td>
                            <td>Yes</td>
                            <td>Invoice, CreditNote, ApplicationResponse</td>
                        </tr>
                        <tr>
                            <td><code>senderReference</code></td>
                            <td>Yes</td>
                            <td>Unique identifier from your system (must be unique per sending company)</td>
                        </tr>
                        <tr>
                            <td><code>sendingCompanyId</code></td>
                            <td>Yes</td>
                            <td>The companyId of the legal entity sending this invoice</td>
                        </tr>
                        <tr>
                            <td><code>systemType</code></td>
                            <td>No</td>
                            <td>Oracle, SAP, SAP Ariba, or Other</td>
                        </tr>
                        <tr>
                            <td><code>documentIdentifier</code></td>
                            <td>No</td>
                            <td>Invoice number (searchable in UI, shown even if processing fails)</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-warning">
                    <strong>Critical: senderReference</strong>
                    <ul style="margin-bottom: 0;">
                        <li>Must be globally unique for each document from a sending company</li>
                        <li>Recommendation: <code>{InvoiceNumber}-{Timestamp}-{RandomSuffix}</code></li>
                        <li>Example: <code>INV-2025-001234-20250115143022-a7f3</code></li>
                        <li>Store this value in your database linked to the invoice</li>
                    </ul>
                </div>

                <h3>Step 2: Poll for Status Updates</h3>
                <p>Documents go through multiple status changes. Poll regularly to track progress.</p>

                <p><strong>Endpoint:</strong></p>
                <pre><code class="language-http">GET /einvoicing/document/v1/documents?
companyId={company_id}&
direction=Sent&
documentType=Invoice&
modifiedTimeFrom=2025-01-15T10:00:00Z&
pageIndex=0&
pageSize=100&
sort=modifiedTime</code></pre>

                <h4>Status Fields</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Status Field</th>
                            <th>Values</th>
                            <th>Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>sendStatus</code></td>
                            <td>Processing, Done, Error, Cancelled</td>
                            <td>Overall sending status</td>
                        </tr>
                        <tr>
                            <td><code>clearanceStatus</code></td>
                            <td>Pending, Approved, Rejected</td>
                            <td>Tax authority clearance (CTC countries)</td>
                        </tr>
                        <tr>
                            <td><code>businessStatus</code></td>
                            <td>Accepted, Rejected, UnderQuery</td>
                            <td>Business-level acceptance from buyer</td>
                        </tr>
                        <tr>
                            <td><code>externalStatus</code></td>
                            <td>Various</td>
                            <td>External party responses</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-info">
                    <strong>Polling Best Practice:</strong> Use <code>modifiedTimeFrom</code> set to the latest <code>modifiedTime</code>
                    from previous poll. Sort by <code>modifiedTime</code> ascending. Don't use offset-based pagination.
                    <br><br>
                    <strong>Related APIs:</strong> <a href="api-reference.html#get-documents" style="color: #004085;">Get Documents API</a> |
                    <a href="api-reference.html#get-document" style="color: #004085;">Get A Document API</a> |
                    <a href="api-reference.html#action" style="color: #004085;">Action API</a>
                </div>

                <h2 id="ap-flow">Accounts Payable (AP) - Inbound Invoice Flow</h2>
                <p class="intro">
                    This section covers receiving invoices FROM suppliers TO your clients. The AP flow handles
                    polling for received documents, downloading formats, and importing into your system.
                </p>

                <h3>AP Flow Overview</h3>
                <div class="diagram">┌─────────────────┐          ┌──────────────────────┐
│ Supplier        │─────────>│ ONESOURCE PLATFORM   │
│ (Sends Invoice) │          │ (Validates & Stores) │
└─────────────────┘          └──────────┬───────────┘
                                        │
                                        │
                         ┌──────────────▼─────────────┐
                         │ YOUR PLATFORM              │
                         │                            │
                         │ 1. Poll for new invoices   │
                         │ 2. Download target format  │
                         │ 3. Import into AP system   │
                         │ 4. Mark as fetched         │
                         │ 5. Send response           │
                         └────────────────────────────┘</div>

                <h3>Step 1: Poll for Received Invoices</h3>
                <p><strong>Endpoint:</strong></p>
                <pre><code class="language-http">GET /einvoicing/document/v1/documents?
companyId={company_id}&
direction=Received&
documentType=Invoice&
createTimeFrom=2025-01-15T08:00:00Z&
createTimeTo=2025-01-15T09:00:00Z&
pageIndex=0&
pageSize=100&
sort=createTime</code></pre>

                <h4>Key Differences from AR Polling</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>AR (Sent)</th>
                            <th>AP (Received)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>direction</td>
                            <td>Sent</td>
                            <td>Received</td>
                        </tr>
                        <tr>
                            <td>Time parameter</td>
                            <td>modifiedTimeFrom</td>
                            <td>createTimeFrom + createTimeTo</td>
                        </tr>
                        <tr>
                            <td>sort</td>
                            <td>modifiedTime</td>
                            <td>createTime</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert alert-info">
                    <strong>Why createTimeFrom/To?</strong> Received documents don't change after initial receipt.
                    Use time windows to incrementally fetch new invoices. Next poll: set <code>createTimeFrom</code>
                    = previous <code>createTimeTo</code>.
                    <br><br>
                    <strong>Related APIs:</strong> <a href="api-reference.html#get-documents" style="color: #004085;">Get Documents API</a> |
                    <a href="api-reference.html#target" style="color: #004085;">Target API</a> |
                    <a href="api-reference.html#external-status" style="color: #004085;">External Status API</a>
                </div>

                <h3>Step 2: Download Target Document</h3>
                <p>The target document is the format configured for your client to receive (typically UBL, PEPPOL, or another standard format).</p>

                <pre><code class="language-http">GET /einvoicing/document/v1/documents/{id}/target-document
Authorization: Bearer {access_token}</code></pre>

                <p><strong>Response:</strong> XML document (UBL, PEPPOL, etc.) or PDF if no structured format configured</p>

                <h3>Step 3: Mark as Fetched</h3>
                <p>After successfully importing, mark the document as fetched to prevent reprocessing:</p>

                <pre><code class="language-json">POST /einvoicing/document/v1/documents/fetch

{
  "documentIds": [
    "52939209-f454-498e-afd0-64b0827c4eb0",
    "a297a938-2c3d-4051-1193-667b0ffa19ad"
  ]
}</code></pre>

                <h2 id="puf-format">Pagero Universal Format (PUF)</h2>
                <p class="intro">
                    PUF is a structured XML format based on UBL 2.1 that enables the exchange of compliant business
                    documents worldwide. Submit once in PUF, and ONESOURCE automatically converts to 50+ country-specific formats.
                </p>

                <h3>Why PUF?</h3>
                <ul>
                    <li><strong>Single format</strong> for all countries and recipients</li>
                    <li><strong>Based on UBL 2.1</strong> - Widely adopted standard</li>
                    <li><strong>Automatic conversion</strong> to country-specific formats (FatturaPA, CFDI, Factur-X, etc.)</li>
                    <li><strong>No country expertise needed</strong> - ONESOURCE handles local requirements</li>
                </ul>

                <h3>PUF Resources</h3>
                <ul>
                    <li><a href="https://pagero.github.io/puf-billing/" target="_blank">Full PUF Specification</a></li>
                    <li><a href="https://github.com/pagero/puf-billing/tree/master/examples" target="_blank">Example Files</a></li>
                    <li><a href="https://pagero.validex.net/" target="_blank">Validation Tool</a></li>
                </ul>

                <h2 id="status-polling">Status Polling Strategy</h2>
                <p class="intro">
                    E-invoicing is inherently asynchronous. Implement robust polling to track document status changes.
                </p>

                <h3>Polling Frequency Recommendations</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Frequency</th>
                            <th>Rationale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Low volume (&lt;100/day)</td>
                            <td>Every 15-30 minutes</td>
                            <td>Balance between freshness and API load</td>
                        </tr>
                        <tr>
                            <td>Medium volume (100-1000/day)</td>
                            <td>Every 5-10 minutes</td>
                            <td>More frequent updates needed</td>
                        </tr>
                        <tr>
                            <td>High volume (&gt;1000/day)</td>
                            <td>Every 2-5 minutes</td>
                            <td>Near real-time status updates</td>
                        </tr>
                        <tr>
                            <td>Error checking</td>
                            <td>Every 30-60 minutes</td>
                            <td>Errors don't change frequently</td>
                        </tr>
                    </tbody>
                </table>

                <h2 id="error-handling">Error Handling</h2>
                <p class="intro">
                    Comprehensive error handling is critical for e-invoicing integration. Different error types require different remediation strategies.
                </p>

                <h3>Common Error Scenarios</h3>

                <h4>1. Recipient Not Found</h4>
                <div class="alert alert-error">
                    <strong>Error Message:</strong> "Recipient of document (Customer Name) did not match any recipient in Pagero public customer registry or in your customer directory."
                </div>

                <p><strong>Cause:</strong></p>
                <ul>
                    <li>Recipient doesn't exist in Pagero network</li>
                    <li>Recipient not added to sender's customer directory (if using closed directory)</li>
                    <li>Identifier mismatch (VAT number, organization number, etc.)</li>
                </ul>

                <p><strong>Resolution:</strong></p>
                <ol>
                    <li>User must log into Pagero Online</li>
                    <li>Navigate to Customer Directory → Search</li>
                    <li>Search for recipient by name, VAT number, or organization number</li>
                    <li>If recipient exists: Add to customer directory and retry</li>
                    <li>If recipient doesn't exist: Suggest new recipient via Pagero Online</li>
                </ol>

                <h4>2. Validation Errors</h4>
                <div class="alert alert-error">
                    <strong>Examples:</strong>
                    <ul style="margin-bottom: 0;">
                        <li>"XML validation failed: Element 'cbc:ID' is required"</li>
                        <li>"Invalid VAT number format"</li>
                        <li>"Tax amount calculation mismatch"</li>
                    </ul>
                </div>

                <p><strong>Resolution:</strong></p>
                <ol>
                    <li>Validate PUF XML before submission using <a href="https://pagero.validex.net/" target="_blank">Validex tool</a></li>
                    <li>Fix data issues in source system</li>
                    <li>Cancel errored document</li>
                    <li>Resubmit corrected document</li>
                </ol>

                <h3>Document Actions API</h3>
                <p>When a document has <code>sendStatus = Error</code>, you can take action on it:</p>

                <pre><code class="language-json">POST /einvoicing/document/v1/documents/{id}/action

{
  "action": "Cancel"  // Or: Resume, Restart, RestartWithReplacements
}</code></pre>

                <h2 id="code-examples">Code Examples</h2>
                <p class="intro">
                    Practical code examples for common integration tasks.
                </p>

                <h3>Example 1: Sending an Invoice</h3>
                <pre><code class="language-python">import requests
import time
import uuid

def send_invoice(invoice_data, company_id, access_token):
    """Send an invoice to ONESOURCE"""

    # Generate PUF XML from your invoice data
    puf_xml = build_puf_invoice(invoice_data)

    # Generate unique sender reference
    sender_reference = f"{invoice_data['invoice_number']}-{int(time.time())}-{uuid.uuid4().hex[:8]}"

    # POST document
    response = requests.post(
        "https://api-uat.onesourcetax.com/einvoicing/document/v1/documents",
        headers={
            "Authorization": f"Bearer {access_token}",
            "Content-Type": "application/json"
        },
        json={
            "payload": puf_xml,
            "documentType": "Invoice",
            "senderReference": sender_reference,
            "sendingCompanyId": company_id,
            "systemType": "Other",
            "systemName": "YourPlatform",
            "documentIdentifier": invoice_data['invoice_number']
        }
    )

    if response.status_code in [200, 201]:
        document_id = response.json()["id"]

        # Store mapping in database
        save_document_mapping(
            invoice_id=invoice_data['id'],
            sender_reference=sender_reference,
            document_id=document_id
        )

        return document_id
    else:
        raise Exception(f"Failed to send invoice: {response.text}")</code></pre>

                <h3>Example 2: Polling for Status Updates</h3>
                <pre><code class="language-javascript">async function pollDocumentStatus(companyId, lastPollTime) {
    const baseUrl = 'https://api-uat.onesourcetax.com';
    const accessToken = await getAccessToken();

    let allDocuments = [];
    let pageIndex = 0;

    while (true) {
        const params = new URLSearchParams({
            companyId: companyId,
            direction: 'Sent',
            documentType: 'Invoice',
            modifiedTimeFrom: lastPollTime,
            pageIndex: pageIndex,
            pageSize: 100,
            sort: 'modifiedTime'
        });

        const response = await fetch(`${baseUrl}/einvoicing/document/v1/documents?${params}`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });

        const data = await response.json();
        const documents = data.items;

        if (!documents || documents.length === 0) {
            break;
        }

        allDocuments = allDocuments.concat(documents);

        if (pageIndex + 1 >= data.meta.totalPages) {
            break;
        }

        pageIndex++;
    }

    // Update last poll time
    if (allDocuments.length > 0) {
        const latestModified = Math.max(...allDocuments.map(doc => new Date(doc.modifiedTime)));
        await saveLastPollTime(companyId, new Date(latestModified).toISOString());
    }

    return allDocuments;
}</code></pre>

                <div class="alert alert-success">
                    <h4 style="margin-top: 0;">Next Steps</h4>
                    <p>For more detailed examples and country-specific implementations, visit:</p>
                    <ul style="margin-bottom: 0;">
                        <li><a href="https://github.com/pagero/puf-billing/tree/master/examples" target="_blank" style="color: #155724;">PUF Examples on GitHub</a></li>
                        <li><a href="https://developers.thomsonreuters.com" target="_blank" style="color: #155724;">TR Developer Portal</a></li>
                        <li><a href="faq.html" style="color: #155724;">FAQ & Troubleshooting</a></li>
                    </ul>
                </div>
            </main>

            <!-- Footer -->
            <footer class="site-footer" style="border-top: 1px solid var(--color-medium-gray); padding: 2rem 3rem; margin-top: 4rem;">
                <p style="text-align: center; color: var(--color-gray); font-size: 0.875rem;">
                    © 2025 Thomson Reuters. All rights reserved.
                </p>
            </footer>
        </div>

        <!-- Right Sidebar (Table of Contents) -->
        <aside class="sidebar-right">
            <div class="toc-heading">Contents</div>
            <ul class="toc-list">
                <!-- Generated dynamically by JavaScript -->
            </ul>
        </aside>
    </div>

    <!-- Chatbot Widget -->
    <div id="chatbot-container"></div>

    <!-- Scripts -->
    <script src="assets/js/theme-toggle.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/navigation.js"></script>
    <script src="assets/js/chatbot-ui.js"></script>
    <script src="assets/js/openarena-client.js"></script>
    <script src="assets/js/chatbot-controller.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
</body>
</html>
