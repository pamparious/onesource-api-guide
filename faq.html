<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="TR ONESOURCE E-Invoicing FAQ - Common questions, troubleshooting, and best practices">
    <title>FAQ | TR ONESOURCE E-Invoicing</title>

    <!-- Dark Mode Detection (must run before styles to avoid flash) -->
    <script>
        (function() {
            const cl = document.documentElement.classList;
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                cl.add('dark');
            }
        })();
    </script>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/chatbot.css">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Fixed Header -->
    <header class="site-header">
        <!-- Mobile Header (< 1024px) -->
        <div class="mobile-header-wrapper">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="mobile-menu-toggle" aria-label="Toggle navigation menu">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="index.html" class="mobile-brand">
                    <div class="mobile-logo-box">
                        <span class="mobile-logo-text">TR</span>
                    </div>
                    <span class="mobile-brand-text">ONESOURCE</span>
                </a>
            </div>
            <a href="index.html" class="mobile-doc-link">Documentation</a>
        </div>

        <!-- Desktop Header (>= 1024px) -->
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; height: 100%; padding: 0 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="index.html" class="navbar-brand navbar-brand-desktop" style="display: flex; align-items: center; gap: 1rem; text-decoration: none;">
                    <div style="background-color: white; padding: 6px 12px; border-radius: 6px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <img src="assets/images/Thomson-Reuters-Logo-500x281.png" alt="Thomson Reuters" style="height: 32px; width: auto; display: block;">
                    </div>
                    </a>
            </div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button id="headerAIButton" class="header-ai-button" aria-label="Open AI Assistant">
                    <i class="fas fa-robot"></i>
                    <span class="ai-button-text">AI Assistant</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Overlay for mobile sidebar -->
    <div class="sidebar-overlay"></div>

    <!-- Main Container -->
    <div id="retype-container">
        <!-- Left Sidebar Navigation -->
        <aside class="sidebar-left">
            <nav class="sidebar-nav">
                <!-- Home Section -->
                <div class="nav-section">
                    <a href="index.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-home" style="margin-right: 0.5rem; width: 20px;"></i> Home</span>
                    </a>
                </div>

                <!-- Getting Started Section -->
                <div class="nav-section">
                    <a href="getting-started.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-rocket" style="margin-right: 0.5rem; width: 20px;"></i> Getting Started</span>
                    </a>
                </div>

                <!-- E-Invoicing Integration Section -->
                <div class="nav-section">
                    <a href="einvoicing-integration.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-file-invoice" style="margin-right: 0.5rem; width: 20px;"></i> E-Invoicing Integration</span>
                    </a>
                </div>

                <!-- API Reference Section -->
                <div class="nav-section">
                    <a href="api-reference.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-code" style="margin-right: 0.5rem; width: 20px;"></i> API Reference</span>
                    </a>
                </div>

                <!-- Partner Onboarding Section -->
                <div class="nav-section">
                    <a href="partner-onboarding.html" class="nav-section-title" style="text-decoration: none;">
                        <span><i class="fas fa-handshake" style="margin-right: 0.5rem; width: 20px;"></i> Partner Onboarding</span>
                    </a>
                </div>

                <!-- FAQ Section (Active) -->
                <div class="nav-section">
                    <div class="nav-section-title active">
                        <span><i class="fas fa-question-circle" style="margin-right: 0.5rem; width: 20px;"></i> FAQ</span>
                        <i class="fas fa-chevron-down nav-section-icon"></i>
                    </div>
                    <div class="nav-section-items">
                        <a href="#getting-started" class="nav-item">Getting Started</a>
                        <a href="#authentication" class="nav-item">Authentication</a>
                        <a href="#integration" class="nav-item">Integration</a>
                        <a href="#troubleshooting" class="nav-item">Troubleshooting</a>
                        <a href="#best-practices" class="nav-item">Best Practices</a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <main class="main-content-area">
                <h1 id="overview">Frequently Asked Questions</h1>
                <p class="intro" style="font-size: 1.125rem; color: var(--color-gray); margin-bottom: 2rem;">
                    Find answers to common questions about TR ONESOURCE E-Invoicing API integration.
                    Use our AI assistant (bottom-right corner) for personalized help.
                </p>

                <h2 id="getting-started">Getting Started</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What is TR ONESOURCE E-Invoicing?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    TR ONESOURCE E-Invoicing is a centralized platform designed to streamline electronic invoicing
                                    management for multinational businesses. It offers pre-built integrations connecting financial systems,
                                    including common ERP systems, and provides compliance with e-invoicing mandates in 80+ countries.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I become a partner?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Contact the Thomson Reuters ONESOURCE team and express interest in becoming an integration partner.
                                Discuss your client base, use cases, and geographic scope. The team will provide you with:</p>
                                <ul>
                                    <li>Universal partner credentials (client_id and client_secret)</li>
                                    <li>Test accounts for development</li>
                                    <li>Access to developer documentation</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What is companyId and why is it important?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    <code>companyId</code> is a unique identifier (UUID format) for each legal entity your client operates.
                                    It's mandatory for all API calls involving documents. Each legal entity (e.g., "Global Manufacturing Sweden AB")
                                    has its own companyId, VAT/tax identifiers, and can be grouped in hierarchical structures.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What testing environments are available?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>ONESOURCE provides two environments:</p>
                                <ul>
                                    <li><strong>UAT (Testing):</strong> <code>https://api-uat.onesourcetax.com</code> for development and testing</li>
                                    <li><strong>PROD (EMEA):</strong> <code>https://api-emea.onesourcetax.com</code> for production</li>
                                </ul>
                                <p>Note: There is no separate sandbox. Testing is done in UAT using test accounts and document send modes
                                (Certification/Test/Production).</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 id="authentication">Authentication</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What OAuth 2.0 flows are supported?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>ONESOURCE supports two OAuth 2.0 grant types:</p>
                                <ul>
                                    <li><strong>Client Credentials Grant:</strong> For partner-level API access (getting access tokens)</li>
                                    <li><strong>Authorization Code Grant:</strong> For end-user authorization (granting access to client data)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How long do access tokens last?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    Access tokens expire in 1799 seconds (~30 minutes). You should implement token caching and refresh logic.
                                    Do NOT request a new token for every API call. Store the token with its expiry timestamp and refresh when needed.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I handle token expiration?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Implement automatic refresh before expiry:</p>
                                <ol>
                                    <li>Check if token is still valid before each API call (with 60s buffer)</li>
                                    <li>Use refresh token to get new access token without user interaction</li>
                                    <li>Handle refresh token expiration (require re-authorization)</li>
                                    <li>On 401 errors, attempt token refresh, then retry the request</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How should I store tokens securely?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Best practices for token storage:</p>
                                <ul>
                                    <li>Store tokens encrypted in your database</li>
                                    <li>Never log tokens or expose them in URLs</li>
                                    <li>Associate tokens with user/tenant ID</li>
                                    <li>Implement secure key management for encryption keys</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 id="integration">Integration</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What is PUF and why should I use it?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    Pagero Universal Format (PUF) is a structured XML format based on UBL 2.1 that enables document exchange worldwide.
                                    Submit once in PUF, and ONESOURCE automatically converts to 50+ country-specific formats (FatturaPA, CFDI, Factur-X, etc.).
                                    This means you don't need country-specific expertise or separate integrations.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I generate PUF XML?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Options for generating PUF XML:</p>
                                <ol>
                                    <li>Use an XML library to build the structure programmatically</li>
                                    <li>Use XML templates with placeholders for your invoice data</li>
                                    <li>Use PUF code libraries if available for your platform</li>
                                    <li>Validate your XML using the <a href="https://pagero.validex.net/" target="_blank">Validex tool</a> before submission</li>
                                </ol>
                                <p>See the <a href="einvoicing-integration.html#puf-format">PUF Format section</a> for a complete example and the
                                <a href="api-reference.html#post-documents">Post Documents API</a> for submission details.</p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What is senderReference and why must it be unique?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    <code>senderReference</code> is a unique identifier from your system that you provide when submitting documents.
                                    It must be globally unique for each document from a sending company to prevent duplicates and enable tracking.
                                </p>
                                <p><strong>Recommendation:</strong> <code>{InvoiceNumber}-{Timestamp}-{RandomSuffix}</code></p>
                                <p><strong>Example:</strong> <code>INV-2025-001234-20250115143022-a7f3</code></p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How often should I poll for status updates?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Polling frequency depends on volume:</p>
                                <ul>
                                    <li><strong>Low volume (&lt;100/day):</strong> Every 15-30 minutes</li>
                                    <li><strong>Medium volume (100-1000/day):</strong> Every 5-10 minutes</li>
                                    <li><strong>High volume (&gt;1000/day):</strong> Every 2-5 minutes</li>
                                    <li><strong>Error checking:</strong> Every 30-60 minutes</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What's the difference between AR and AP flows?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    <strong>AR (Accounts Receivable) - Outbound:</strong> Sending invoices FROM your clients TO their customers.
                                    You POST documents, poll for status changes, and handle errors.
                                </p>
                                <p>
                                    <strong>AP (Accounts Payable) - Inbound:</strong> Receiving invoices FROM suppliers TO your clients.
                                    You poll for received documents, download target format, import to your system, and mark as fetched.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 id="troubleshooting">Troubleshooting</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What does "Recipient not found" error mean?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>This error occurs when:</p>
                                <ul>
                                    <li>Recipient doesn't exist in Pagero network</li>
                                    <li>Recipient not added to sender's customer directory (if using closed directory)</li>
                                    <li>Identifier mismatch (VAT number, organization number)</li>
                                </ul>
                                <p><strong>Resolution:</strong> User must log into Pagero Online, search for recipient in Customer Directory,
                                and either add them or suggest new recipient registration.</p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>Why was my invoice rejected by the tax authority?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Common causes of clearance rejection in CTC countries:</p>
                                <ul>
                                    <li>Tax calculation errors</li>
                                    <li>Invalid tax codes</li>
                                    <li>Missing mandatory country-specific fields</li>
                                    <li>Duplicate invoice number</li>
                                </ul>
                                <p><strong>Resolution:</strong> Review clearance error details, cancel the rejected document, correct issues in your
                                source system, and resubmit with a new invoice number if needed.</p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What are the different document statuses?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Documents have multiple status fields:</p>
                                <ul>
                                    <li><strong>sendStatus:</strong> Processing, Done, Error, Cancelled (overall sending status)</li>
                                    <li><strong>clearanceStatus:</strong> Pending, Approved, Rejected (tax authority clearance for CTC countries)</li>
                                    <li><strong>businessStatus:</strong> Accepted, Rejected, UnderQuery (business-level acceptance from buyer)</li>
                                    <li><strong>externalStatus:</strong> Various external party responses</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I validate my PUF XML before submission?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Use the <a href="https://pagero.validex.net/" target="_blank">Pagero Validex tool</a> to validate your PUF XML.
                                Upload your XML file and it will check for:</p>
                                <ul>
                                    <li>XML structure validity</li>
                                    <li>Required fields presence</li>
                                    <li>Data format correctness</li>
                                    <li>Business rule compliance</li>
                                </ul>
                                <p>Fix any validation errors before submitting via the API.</p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How long are documents retained in ONESOURCE?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    Documents are retained for 90 days standard. You must fetch and archive documents locally within this period.
                                    Note that some countries require longer archival periods (10+ years), so implement a local archival strategy.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <h2 id="best-practices">Best Practices</h2>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How should I implement polling?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Follow these polling best practices:</p>
                                <ul>
                                    <li>Use <code>modifiedTimeFrom</code> set to the latest <code>modifiedTime</code> from previous poll</li>
                                    <li>Sort by <code>modifiedTime</code> ascending</li>
                                    <li>Don't use offset-based pagination (documents can be modified at any time)</li>
                                    <li>Store the latest <code>modifiedTime</code> for next poll iteration</li>
                                    <li>Implement exponential backoff for retries on errors</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What should I do with fetched documents?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>After processing documents:</p>
                                <ol>
                                    <li>Download and archive PDF presentations locally</li>
                                    <li>Download target format for AP processing</li>
                                    <li>Store document metadata in your database</li>
                                    <li>Mark documents as fetched using the <code>/documents/fetch</code> endpoint</li>
                                    <li>Implement a retention policy aligned with legal requirements</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I handle errors gracefully?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Error handling strategy:</p>
                                <ul>
                                    <li>Distinguish between retriable and non-retriable errors</li>
                                    <li>Implement exponential backoff for retriable errors (401, 429, 500)</li>
                                    <li>Alert on persistent errors</li>
                                    <li>Maintain error logs for compliance audits</li>
                                    <li>Provide clear error messages to end users</li>
                                    <li>Use the Document Actions API to cancel/restart/resume errored documents</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What's the recommended database schema for mappings?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>Store these key mappings:</p>
                                <ul>
                                    <li><strong>Company Mapping:</strong> your_company_id ↔ onesource_company_id</li>
                                    <li><strong>Document Mapping:</strong> your_invoice_id ↔ sender_reference ↔ onesource_document_id</li>
                                    <li><strong>Status Tracking:</strong> send_status, clearance_status, business_status, modified_time</li>
                                    <li><strong>Polling State:</strong> last_poll_time per company</li>
                                </ul>
                                <p>See the <a href="einvoicing-integration.html#code-examples">Code Examples</a> for sample database schemas and the
                                <a href="api-reference.html">API Reference</a> for detailed endpoint documentation.</p>
                            </div>
                        </div>
                    </div>

                    <div class="faq-item">
                        <div class="faq-question">
                            <span>Should I implement webhooks or polling?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            <div class="faq-answer-content">
                                <p>
                                    Currently, ONESOURCE E-Invoicing uses polling for status updates. Implement robust polling with appropriate
                                    frequency based on your document volume. The modified-time-based polling approach ensures you don't miss updates
                                    and handles documents that may be modified multiple times.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Footer -->
            <footer class="site-footer" style="border-top: 1px solid var(--color-medium-gray); padding: 2rem 3rem; margin-top: 4rem;">
                <p style="text-align: center; color: var(--color-gray); font-size: 0.875rem;">
                    © 2025 Thomson Reuters. All rights reserved.
                </p>
            </footer>
        </div>

        <!-- Right Sidebar (Table of Contents) -->
        <aside class="sidebar-right">
            <div class="toc-heading">Contents</div>
            <ul class="toc-list">
                <!-- Generated dynamically by JavaScript -->
            </ul>
        </aside>
    </div>

    <!-- Chatbot Widget -->
    <div id="chatbot-container"></div>

    <!-- Scripts -->
    <script src="assets/js/theme-toggle.js"></script>
    <script src="assets/js/layout.js"></script>
    <script src="assets/js/navigation.js"></script>
    <script src="assets/js/chatbot-ui.js"></script>
    <script src="assets/js/openarena-client.js"></script>
    <script src="assets/js/report-context-manager.js"></script>
    <script src="assets/js/supervisor-agent.js"></script>
    <script src="assets/js/chatbot-controller.js"></script>

    <!-- FAQ Accordion Script -->
    <script>
        document.querySelectorAll('.faq-question').forEach(question => {
            question.addEventListener('click', function() {
                const faqItem = this.closest('.faq-item');
                faqItem.classList.toggle('active');
            });
        });
    </script>
</body>
</html>
